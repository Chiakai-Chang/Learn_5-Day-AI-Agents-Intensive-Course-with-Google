### 🎙️ 第 10 頁：CICD_Stages_Pre-Merge,_Staging,_and_Production

#### 【本頁重點摘要】
*   一個強健的 CI/CD 流程分為三個階段，像漏斗一樣，逐步篩選問題，確保品質。
*   **第一階段 (Pre-Merge CI)**：合併前的快速檢查，包含單元測試、程式碼風格、依賴項掃描與最重要的「智能體品質評估」。
*   **第二階段 (Post-Merge Staging)**：合併後的整合驗證，在模擬生產環境中進行負載測試與內部真人測試 (Dogfooding)。
*   **第三階段 (Gated Production)**：有閘門的生產部署，通常需要產品負責人手動批准，確保萬無一失。
*   整個流程由「基礎設施即代碼 (IaC)」、「自動化測試框架」與「密鑰管理」等技術支撐。

---

#### 【逐字講稿】

(開場白)
好，我們剛剛談到，一個 AI 智能體是個複雜的「複合式系統」，它不只有程式碼，還有提示、工具定義等等。那麼，我們該如何確保對其中任何一項的修改，都不會搞砸整個系統呢？答案就是一個紀律嚴明的「三階段 CI/CD 流程」。

各位可以把這個流程想像成一個**漏斗**。我們的目標，是在越早的階段、用越低的成本把錯誤攔截下來。

##### ① 第一階段：合併前的整合 (Pre-Merge CI)
這就像是我們品管的第一道防線。當一位 AI 工程師或提示工程師提交了新的修改時，這個流程會自動觸發。它的目的，是提供「快速回饋」。

> 在這個階段，我們會執行速度飛快的檢查，例如：**單元測試**、確保程式碼風格一致的 **Linting**、掃描是否有已知漏洞的**依賴項掃描 (dependency scanning)**，以及最關鍵的——執行我們前面提到的「**智能體品質評估套件**」。

這一步讓我們在程式碼被合併到主分支「之前」，就能立刻知道這次修改是讓智能體變得更好了，還是變差了。這可以有效防止有問題的程式碼污染了我們的主幹。

##### ② 第二階段：合併後於「預備環境」的驗證 (Post-Merge Staging)
一旦修改通過了所有第一階段的檢查並被合併，我們的焦點就從「程式碼本身」轉移到「整個系統的整合運作」上。

這時候，CD (持續部署) 流程會啟動，將我們最新的智能體版本，部署到一個我們稱之為「Staging」的預備環境。這個環境是**生產環境的忠實複製品**，一模一樣。在這裡，我們會進行更耗時、更全面的測試，例如**負載測試**，看看它能否應對高流量；或是**整合測試**，確保它跟其他外部服務的對接沒問題。

更重要的是，這個階段也是我們進行內部真人測試，也就是所謂「**吃自己的狗糧 (dogfooding)**」的最佳時機。讓公司內部同仁先試用，在它接觸到真實客戶之前，提供最直接的質化回饋。

##### ③ 第三階段：有閘門的「生產環境」部署 (Gated Production)
當智能體在預備環境中被完整驗證後，就剩下最後一步：推向世界！但這一步，我們幾乎「**從不**」讓它完全自動化。

> 這通常會需要一位**產品負責人 (Product Owner)** 的最終簽核，作為一個人為的「煞車」機制。一但批准，那份「**在 Staging 環境被完整測試過的部署包**」，會被原封不動地推廣到生產環境。這確保了我們上線的東西，跟我們測試的東西是完全一樣的。

##### ④ 驅動這一切的背後功臣
要讓這三階段流程順暢運作，需要幾個關鍵的自動化技術：
*   **基礎設施即代碼 (IaC)**：像是用 **Terraform** 這類工具，把我們的雲端環境設定寫成程式碼。這確保了我們的開發、預備、生產環境都是完全一致、可重複創建的。
*   **自動化測試框架**：像是 **Pytest**，它能自動執行我們在每個階段設定的測試，並處理智能體特有的測試產物，比如對話紀錄、工具呼叫日誌等。
*   最後，**安全的密鑰管理**也至關重要。所有像 API Keys 這樣的敏感資訊，都應該透過 **Secret Manager** 這類服務在運行時才注入，絕對不能寫死在程式碼裡。

---

#### 【講者提示 & 轉場】
*   **節奏提醒**：講完三個階段後，可以稍微停頓一下，指著螢幕上的圖，讓聽眾消化這個 Pre-Merge -> Staging -> Production 的流程。
*   **補充案例**：如果想舉例，可以提到「我們提供的 Agent Starter Pack 專案中，就包含了這三階段的 Cloud Build 設定檔範本，大家可以直接拿去用。」
*   **轉場橋樑 (Bridge)**：
    > 透過這套嚴謹的 CI/CD 流程，我們確保了每一次部署都是高品質且可信賴的。但即使如此，直接將 100% 的流量切換到新版本仍然有風險。因此，下一頁，我們將探討幾種「安全的部署策略」，讓我們能更平穩地邁出這最後一步。